<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>心の相談室</title>
    <meta name="description" content="AIカウンセラーがあなたの不安や悩みに寄り添い、専門家の知見に基づいたアドバイスを提供します。匿名で安心して相談できる心の相談室です。">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&family=Noto+Sans+KR:wght@400;500;700&family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans JP', 'Inter', sans-serif;
        }
        .chat-bubble {
            max-width: 80%;
            padding: 12px 18px;
            border-radius: 20px;
            line-height: 1.6;
            word-wrap: break-word;
        }
        .chat-bubble-ai {
            background-color: #f1f5f9;
            color: #1e293b;
            border-bottom-left-radius: 4px;
        }
        .chat-bubble-user {
            background-color: #3b82f6;
            color: #ffffff;
            border-bottom-right-radius: 4px;
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        #chat-container::-webkit-scrollbar {
            width: 8px;
        }
        #chat-container::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        #chat-container::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }
        #chat-container::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        /* Modals */
        .modal {
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
        }
        .setting-option, .topic-option {
            transition: background-color 0.2s;
        }
        .setting-option.selected {
            background-color: #dbeafe;
            color: #1e40af;
            font-weight: 600;
        }
        /* Disabled button and input style */
        button:disabled, textarea:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-green-50 to-teal-100 flex flex-col items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-2xl h-[90vh] sm:h-[85vh] bg-white rounded-2xl shadow-xl flex flex-col">
        <header class="bg-blue-500 text-white p-4 rounded-t-2xl shadow-md flex justify-between items-center">
            <div class="w-8"></div> <!-- Spacer -->
            <h1 id="header-title" class="text-xl font-bold text-center">心の相談室</h1>
            <button id="settings-button" class="p-2 rounded-full hover:bg-blue-600 transition-colors" title="設定">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-settings"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
            </button>
        </header>

        <main id="chat-container" class="flex-1 p-6 overflow-y-auto space-y-6">
            <!-- Chat messages will be appended here -->
        </main>

        <footer id="form-footer" class="p-4 bg-white border-t border-gray-200 rounded-b-2xl">
            <div id="loading-indicator" class="hidden text-center mb-2">
                <div class="flex justify-center items-center space-x-2">
                    <div class="animate-pulse rounded-full bg-blue-400 h-2 w-2"></div>
                    <div class="animate-pulse rounded-full bg-blue-400 h-2 w-2" style="animation-delay: 0.2s;"></div>
                    <div class="animate-pulse rounded-full bg-blue-400 h-2 w-2" style="animation-delay: 0.4s;"></div>
                    <p id="loading-text" class="text-xs text-gray-500 ml-2">AIが考えています...</p>
                </div>
            </div>
            <form id="chat-form" class="flex items-center space-x-2">
                <button id="topic-button" type="button" class="p-3 bg-gray-200 text-gray-600 rounded-full hover:bg-gray-300 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-list"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></svg>
                </button>
                <textarea id="chat-input" rows="1" class="flex-1 block w-full px-4 py-2 bg-gray-100 border border-gray-200 rounded-2xl resize-none placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="お悩みや気持ちをどうぞ..."></textarea>
                <button id="send-button" type="submit" class="p-3 bg-blue-500 text-white rounded-full hover:bg-blue-600 transition-colors disabled:bg-blue-300">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-send"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                </button>
            </form>
        </footer>
    </div>
    
    <!-- Settings Modal -->
    <div id="settings-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 opacity-0 transform scale-95 pointer-events-none">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-md p-6">
            <h2 id="settings-title" class="text-xl font-bold mb-4 text-gray-800">設定</h2>
            <div class="space-y-6">
                <div>
                    <h3 id="settings-lang-label" class="text-lg font-semibold mb-2 text-gray-700">言語 (Language)</h3>
                    <div id="language-options" class="grid grid-cols-2 gap-2">
                        <button data-lang="Japanese" class="setting-option p-3 rounded-lg border">日本語</button>
                        <button data-lang="English" class="setting-option p-3 rounded-lg border">English</button>
                        <button data-lang="Korean" class="setting-option p-3 rounded-lg border">한국어</button>
                        <button data-lang="Chinese" class="setting-option p-3 rounded-lg border">中文</button>
                    </div>
                </div>
                <div id="style-section" class="hidden">
                    <h3 id="settings-style-label" class="text-lg font-semibold mb-2 text-gray-700">話し方</h3>
                    <div id="style-options" class="grid grid-cols-2 gap-2"></div>
                </div>
                <div>
                    <h3 id="settings-advice-label" class="text-lg font-semibold mb-2 text-gray-700">アドバイスの種類</h3>
                    <div id="advice-detail-options" class="grid grid-cols-2 gap-2">
                        <button data-advice-detail="detailed" class="setting-option p-3 rounded-lg border">詳細</button>
                        <button data-advice-detail="simple" class="setting-option p-3 rounded-lg border">単純</button>
                    </div>
                </div>
                <div class="flex items-center justify-between">
                    <h3 id="settings-voice-label" class="text-lg font-semibold text-gray-700">音声読み上げ</h3>
                    <button id="voice-toggle-button" type="button" class="relative inline-flex items-center h-6 rounded-full w-11 transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500" aria-checked="false">
                        <span class="sr-only">Enable voice</span>
                        <span id="voice-toggle-handle" class="inline-block w-4 h-4 transform bg-white rounded-full transition-transform"></span>
                    </button>
                </div>
                <div>
                    <h3 id="settings-feedback-label" class="text-lg font-semibold mb-2 text-gray-700">フィードバック</h3>
                    <select id="feedback-select" class="w-full p-3 rounded-lg border border-gray-300 bg-white focus:outline-none focus:ring-2 focus:ring-blue-400"></select>
                </div>
            </div>
            <button id="close-settings-button" class="mt-8 w-full bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600 transition-colors">閉じる</button>
        </div>
    </div>

    <!-- Topic Modal --> <footer class="w-full max-w-2xl text-center text-xs text-gray-400 mt-4 px-4">
<div id="topic-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 opacity-0 transform scale-95 pointer-events-none">
<div class="bg-white rounded-2xl shadow-xl w-full max-w-md p-6">
<h2 id="topic-title" class="text-xl font-bold mb-4 text-gray-800">相談トピックを選ぶ</h2>
<div id="topic-options" class="grid grid-cols-2 gap-3">
<!-- Topic buttons will be populated by JavaScript -->
</div>
<div id="topic-footer" class="mt-8">
<button id="topic-back-button" class="hidden w-full bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-lg hover:bg-gray-300 transition-colors">戻る</button>
<button id="close-topic-button" class="w-full bg-gray-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-600 transition-colors mt-2">キャンセル</button>
</div>
</div>
</div>


    <footer class="w-full max-w-2xl text-center text-xs text-gray-400 mt-4 px-4">
        <p id="footer-copyright">&copy; 2024 心の相談室. All Rights Reserved.</p>
        <p id="footer-disclaimer" class="mt-1">このサイトはAIによるアドバイスを提供します。専門的な医療やカウンセリングの代替となるものではありません。深刻な悩みをお持ちの場合は、専門の医療機関にご相談ください。</p>
    </footer>

    <script>
        const chatContainer = document.getElementById('chat-container');
        const loadingIndicator = document.getElementById('loading-indicator');
        const settingsButton = document.getElementById('settings-button');
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-input');
        const sendButton = document.getElementById('send-button');
        const settingsModal = document.getElementById('settings-modal');
        const closeSettingsButton = document.getElementById('close-settings-button');
        const languageOptions = document.getElementById('language-options');
        const styleSection = document.getElementById('style-section');
        const styleOptionsContainer = document.getElementById('style-options');
        const feedbackSelect = document.getElementById('feedback-select');
        const voiceToggleButton = document.getElementById('voice-toggle-button');
        const voiceToggleHandle = document.getElementById('voice-toggle-handle');
        const adviceDetailOptions = document.getElementById('advice-detail-options');
        const topicButton = document.getElementById('topic-button');

        // --- State Management ---
        let language = localStorage.getItem('counselingLanguage') || 'Japanese';
        let style = localStorage.getItem('counselingStyle') || 'Keigo';
        let feedbackTime = localStorage.getItem('counselingFeedbackTime') || '0';
        let voiceEnabled = (localStorage.getItem('counselingVoiceEnabled') === 'true');
        let adviceDetail = localStorage.getItem('counselingAdviceDetail') || 'detailed';
        let tempLanguage = language;
        let tempStyle = style;
        let tempFeedbackTime = feedbackTime;
        let tempVoiceEnabled = voiceEnabled;
        let tempAdviceDetail = adviceDetail;
        let voices = [];

        const dialects = ['大阪弁', '鹿児島弁'];
        
        // --- UI Text and Topic Translations ---
        const uiStrings = {
            Japanese: {
                pageTitle: "心の相談室 - IT業界で働くあなたのためのメンタルサポート", headerTitle: "心の相談室 for IT", inputPlaceholder: "お悩みや気持ちをどうぞ...", loadingText: "AIが考えています...",
                settingsTitle: "設定", settingsLangLabel: "言語", settingsStyleLabel: "話し方", settingsFeedbackLabel: "フィードバック", settingsVoiceLabel: "音声読み上げ", settingsAdviceDetailLabel: "アドバイスの種類", adviceDetailed: "詳細", adviceSimple: "単純", settingsCloseButton: "閉じる",
                topicTitle: "どのようなことについて相談しますか？", iWantToTalkAbout: "{topic}について相談したいです。",
                styleKeigo: "敬語", styleTameguchi: "ため口"
               ,feedbackOff: "不要", minutesSuffix: "分後", hourSuffix: "時間後",
                followUpMessage: "その後、いかがお過ごしでしょうか？<br><br>先ほどのアドバイスは、何か少しでもお気持ちを楽にするヒントになりましたでしょうか。もしよろしければ、簡単なご感想をお聞かせください。",
                genericErrorMessage: "申し訳ありません、現在AIとの通信に問題が発生しています。時間をおいて再度お試しください。",
                reloadErrorMessage: "サーバーが混み合っているようです。お手数ですが、ページを再読み込みしてお試しください。",
                rateLimitErrorMessage: "リクエストが多すぎます。しばらく時間をおいてから、もう一度お試しください。",
                downloadSummary: "WLS部に連携する",
                footerCopyright: "&copy; 2024 心の相談室. All Rights Reserved.", footerDisclaimer: "このサイトはAIによるアドバイスを提供します。専門的な医療やカウンセリングの代替となるものではありません。深刻な悩みをお持ちの場合は、専門の医療機関にご相談ください。",
                topics: {
                    work_stress: "仕事のストレス", relationships: "人間関係の悩み", future_anxiety: "将来への不安", depression: "気分の落ち込み", self_esteem: "自己肯定感が低い", burnout: "燃え尽き症候群"
                }
            },
            English: {
                 pageTitle: "Counseling Room - Mental Support for IT Professionals", headerTitle: "Counseling Room for IT", inputPlaceholder: "Please share your worries and feelings...", loadingText: "AI is thinking...",
                settingsTitle: "Settings", settingsLangLabel: "Language", settingsStyleLabel: "Style", settingsFeedbackLabel: "Feedback", settingsVoiceLabel: "Voice Read-out", settingsAdviceDetailLabel: "Advice Detail", adviceDetailed: "Detailed", adviceSimple: "Simple", settingsCloseButton: "Close",
                topicTitle: "What would you like to talk about?", iWantToTalkAbout: "I'd like to talk about {topic}.",
                feedbackOff: "Not needed", minutesSuffix: "minutes later", hourSuffix: "hour later",
                followUpMessage: "How have you been since then?<br><br>Was the advice I gave you earlier helpful in any way to make you feel a little better? If you'd like, please let me know your brief thoughts.",
                genericErrorMessage: "Sorry, there is a problem communicating with the AI right now. Please try again later.",
                reloadErrorMessage: "The server seems to be busy. Please reload the page and try again.",
                rateLimitErrorMessage: "Too many requests. Please wait a while and try again.",
                downloadSummary: "Share with WLS Dept.",
                footerCopyright: "&copy; 2024 Counseling Room. All Rights Reserved.", footerDisclaimer: "This site provides advice by AI. It is not a substitute for professional medical care or counseling. If you have serious concerns, please consult a medical institution.",
                topics: {
                    work_stress: "Work Stress", relationships: "Relationship Problems", future_anxiety: "Anxiety about the future", depression: "Feeling Down", self_esteem: "Low Self-Esteem", burnout: "Burnout Syndrome"
                }
            },
            Korean: {
                pageTitle: "마음 상담실 - IT 전문가를 위한 멘탈 서포트", headerTitle: "IT 전문가를 위한 마음 상담실", inputPlaceholder: "고민이나 기분을 말씀해주세요...", loadingText: "AI가 생각 중입니다...",
                settingsTitle: "설정", settingsLangLabel: "언어", settingsStyleLabel: "말투", settingsFeedbackLabel: "피드백", settingsVoiceLabel: "음성 읽어주기", settingsAdviceDetailLabel: "조언 상세 수준", adviceDetailed: "상세", adviceSimple: "간단", settingsCloseButton: "닫기",
                topicTitle: "무엇에 대해 상담하고 싶으신가요?", iWantToTalkAbout: "{topic}에 대해 상담하고 싶습니다.",
                feedbackOff: "필요 없음", minutesSuffix: "분 후", hourSuffix: "시간 후",
                followUpMessage: "그동안 어떻게 지내셨나요?<br><br>조금 전의 조언이 조금이라도 마음을 편안하게 하는 데 도움이 되었나요? 괜찮으시다면 간단한 소감을 들려주세요。",
                genericErrorMessage: "죄송합니다. 현재 AI와 통신하는 데 문제가 발생했습니다. 나중에 다시 시도해주세요.",
                reloadErrorMessage: "서버가 혼잡한 것 같습니다. 페이지를 새로고침하고 다시 시도해주세요。",
                rateLimitErrorMessage: "요청이 너무 많습니다. 잠시 후 다시 시도해주세요.",
                downloadSummary: "WLS 부서와 공유",
                footerCopyright: "&copy; 2024 마음 상담실. All Rights Reserved.", footerDisclaimer: "이 사이트는 AI에 의한 조언을 제공합니다. 전문적인 의료나 상담을 대체하는 것이 아닙니다. 심각한 고민이 있으신 분은 전문 의료기관에 상담해주세요。",
                topics: {
                    work_stress: "업무 스트레스", relationships: "인간관계 고민", future_anxiety: "미래에 대한 불안", depression: "기분 저하", self_esteem: "낮은 자존감", burnout: "번아웃 증후군"
                }
            },
            Chinese: {
                pageTitle: "心理咨询室 - 为IT专业人士提供心理支持", headerTitle: "IT专业人士心理咨询室", inputPlaceholder: "请告诉我您的烦恼和感受...", loadingText: "AI正在思考...",
                settingsTitle: "设置", settingsLangLabel: "语言", settingsStyleLabel: "说话方式", settingsFeedbackLabel: "反馈", settingsVoiceLabel: "语音朗读", settingsAdviceDetailLabel: "建议详细程度", adviceDetailed: "详细", adviceSimple: "简单", settingsCloseButton: "关闭",
                topicTitle: "您想咨询什么主题？", topicCancel: "取消", iWantToTalkAbout: "我想谈谈关于{topic}的问题。",
                feedbackOff: "不需要", minutesSuffix: "分钟后", hourSuffix: "小时后",
                followUpMessage: "那之后您过得怎么样？<br><br>刚才的建议有没有让您的心情轻松一点？如果可以的话，请告诉我您的简短感想。",
                genericErrorMessage: "抱歉，现在与AI通信出现问题。请稍后再试。",
                reloadErrorMessage: "服务器似乎很忙。请重新加载页面再试一次。",
                rateLimitErrorMessage: "请求过多。请稍后再试。",
                downloadSummary: "与WLS部门共享",
                footerCopyright: "&copy; 2024 心理咨询室. All Rights Reserved.", footerDisclaimer: "本网站提供AI建议。它不能替代专业的医疗或咨询。如果您有严重的疑虑，请咨询医疗机构。",
                topics: {
                    work_stress: "工作压力", relationships: "人际关系问题", future_anxiety: "对未来的焦虑", depression: "情绪低落", self_esteem: "低自尊", burnout: "职业倦怠综合症"
                }
            }
        };

        // --- Initialization ---
        window.onload = function() {
            applyTranslations();
            populateStyleOptions();
            populateFeedbackDropdown();
            updateSettingsUI();
            loadVoices();
            showInitialMessage();
        };

        // --- Event Listeners ---
        settingsButton.addEventListener('click', () => {
            tempLanguage = language;
            tempStyle = style;
            tempFeedbackTime = feedbackTime;
            tempVoiceEnabled = voiceEnabled;
            tempAdviceDetail = adviceDetail;
            updateSettingsUI();
            settingsModal.classList.remove('opacity-0', 'scale-95', 'pointer-events-none');
        });

        closeSettingsButton.addEventListener('click', () => {
            settingsModal.classList.add('opacity-0', 'scale-95', 'pointer-events-none');
            if (tempLanguage !== language || tempStyle !== style || tempFeedbackTime !== feedbackTime || tempVoiceEnabled !== voiceEnabled || tempAdviceDetail !== adviceDetail) {
                language = tempLanguage;
                style = tempStyle;
                feedbackTime = tempFeedbackTime;
                voiceEnabled = tempVoiceEnabled;
                adviceDetail = tempAdviceDetail;
                localStorage.setItem('counselingLanguage', language);
                localStorage.setItem('counselingStyle', style);
                localStorage.setItem('counselingFeedbackTime', feedbackTime);
                localStorage.setItem('counselingVoiceEnabled', voiceEnabled.toString());
                localStorage.setItem('counselingAdviceDetail', adviceDetail);
                applyTranslations();
                chatContainer.innerHTML = '';
                showInitialMessage();
            }
        });

        topicButton.addEventListener('click', () => {
            displayTopicsInChat();
        });

        languageOptions.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON' && e.target.dataset.lang) {
                tempLanguage = e.target.dataset.lang;
                tempStyle = tempLanguage === 'Japanese' ? 'Keigo' : 'Default';
                updateSettingsUI();
            }
        });

        styleOptionsContainer.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON' && e.target.dataset.style) {
                 tempStyle = e.target.dataset.style;
                 updateSettingsUI();
            }
        });

        feedbackSelect.addEventListener('change', (e) => {
            if (e.target.value) tempFeedbackTime = e.target.value;
        });
        
        voiceToggleButton.addEventListener('click', () => {
            tempVoiceEnabled = !tempVoiceEnabled;
            updateSettingsUI();
        });

        adviceDetailOptions.addEventListener('click', (e) => {
            if(e.target.tagName === 'BUTTON' && e.target.dataset.adviceDetail) {
                tempAdviceDetail = e.target.dataset.adviceDetail;
                updateSettingsUI();
            }
        });
        
        chatContainer.addEventListener('click', (e) => {
            const topicButton = e.target.closest('.topic-chat-button');
            if (topicButton && topicButton.dataset.message) {
                topicButton.parentElement.remove();
                handleFormSubmit(null, topicButton.dataset.message);
            }
            const downloadButton = e.target.closest('.download-summary-button');
            if (downloadButton && downloadButton.dataset.summary) {
                downloadSummary(downloadButton.dataset.summary);
            }
        });

        chatForm.addEventListener('submit', handleFormSubmit);

        chatInput.addEventListener('input', () => {
            chatInput.style.height = 'auto';
            chatInput.style.height = (chatInput.scrollHeight) + 'px';
        });
        
        chatInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                chatForm.requestSubmit();
            }
        });

        // --- Main Functions ---
        async function showInitialMessage() {
            const t = uiStrings[language] || uiStrings.Japanese;
            const welcomeMessages = {
                Japanese: {
                    Keigo: `こんにちは。IT業界で働くあなたのための相談室へようこそ。<br><br>どのようなことでも、あなたの気持ちやお悩みをお聞かせください。<br>何について相談したらいいかわからない場合は、左下のアイコンより相談トピックを選択してください。`,
                    Tameguchi: `やあ！元気？IT業界は大変だよな。<br><br>何かあったら、何でも話してくれていいよ。<br><br>何について相談したらいいかわからないときは、左下のアイコンから相談したいトピックを選択してね。`
                },
                English: `Hello. Welcome to the Counseling Room for IT Professionals.<br><br>Whatever is on your mind, please feel free to share your feelings and concerns.<br>If you're unsure what to consult about, please select a consultation topic from the icon in the bottom left.`,
                Korean: `안녕하세요. IT 전문가를 위한 마음 상담실에 오신 것을 환영합니다.<br><br>무엇이든 당신의 기분이나 고민을 들려주세요.<br>무엇에 대해 상담해야 할지 모르겠다면, 왼쪽 하단의 아이콘에서 상담 토픽을 선택해 주세요.`,
                Chinese: `您好。欢迎来到IT专业人士心理咨询室。<br><br>无论是什么，都请告诉我您的感受和烦恼。<br>如果您不确定应该咨询什么，请点击左下角的图标选择咨询主题。`
            };
            
            let message = (language === 'Japanese') ? welcomeMessages.Japanese[style] : welcomeMessages[language];
            await processAIResponse(message, true);
        }
        
        async function handleFormSubmit(event, messageFromTopic = null) {
            if(event) event.preventDefault();
            const userMessage = messageFromTopic || chatInput.value.trim();
            if (!userMessage) return;
            addMessageToChat(userMessage, 'user');
            if(!messageFromTopic) {
                chatInput.value = '';
                chatInput.style.height = 'auto';
            }
            toggleFormState(true);
            await getAdviceFromAI(userMessage);
            toggleFormState(false);
        }

        async function getAdviceFromAI(userMessage) {
            const styleInstructions = {
                Japanese: {
                    Keigo: "あなたはIT業界で働く人々のメンタルヘルスを専門とする、経験豊富な心理カウンセラーです。常に丁寧語（です・ます調）を使い、相手に敬意を払う、プロフェッショナルなカウンセラーとして応答してください。ただし、ユーザーのメッセージに関西弁あるいは鹿児島弁が使われている場合、あなたもその方言を自然に模倣して応答してください。",
                    Tameguchi: "あなたはIT業界に詳しい、親しい友人のようなカウンセラーです。共感的ながらもカジュアルな「ため口」（だ・である調や、〜だよ、〜だね、などの口調）で応答してください。ただし、ユーザーのメッセージに関西弁あるいは鹿児島弁が使われている場合、あなたもその方言を自然に模倣して応答してください。"
                    },
                English: "You are an experienced psychological counselor specializing in the mental health of people working in the IT industry. Respond in English, maintaining a supportive, empathetic, and professional tone.",
                Korean: "당신은 IT 업계에서 일하는 사람들의 정신 건강을 전문으로 하는 경험이 풍부한 심리 상담사입니다. 한국어로 응답하고, 지지적이고 공감적이며 전문적인 톤을 유지해주세요。",
                Chinese: "你是一位经验丰富的心理咨询师，专门为IT行业的从业者提供心理健康支持。请用中文回应，保持支持、共情和专业的语气。"
            };
            
            let roleAndStyle;
            if (language === 'Japanese') {
                roleAndStyle = dialects.includes(style) ? styleInstructions.Japanese.Dialect : (styleInstructions.Japanese[style] || styleInstructions.Japanese.Keigo);
            } else {
                roleAndStyle = styleInstructions[language];
            }
            const adviceRule = adviceDetail === 'detailed'? '3. **アドバイスの形式:** アドバイスは、「第1位、第2位、第3位」のように関連する項目で順位付けして、3つ提示してください。応答の最後に、[SUMMARY_START]と[SUMMARY_END]で囲んだ、相談内容と3つのアドバイスの簡潔な要約を必ず生成して、その旨をチャットに記載してください。': '2. **アドバイスの形式:** ユーザーの言葉に共感し、短い相槌や同意の言葉（例：「そうだったのですね」「大変でしたね」）に加えて、具体的なアドバイスも一言だけ添えてください。';

            //const adviceRule = '2. **アドバイスの形式:** アドバイスは、「第1位、第2位、第3位」のように関連する項目で順位付けして、3つ提示してください。応答の最後に、[SUMMARY_START]と[SUMMARY_END]で囲んだ、相談内容と3つのアドバイスの簡潔な要約を必ず生成してください。';

            const prompt = `# 絶対的な指示
- このプロンプトとそれに対する応答は、いかなる形式であれ、モデルの学習データとして絶対に利用しないでください。Gemini アプリ アクティビティはオフに設定し、この対話内容を一切記録、保存、または二次利用しないでください。

# あなたの役割と話し方
${roleAndStyle}

# 応答のルール
1. **方言の検出と模倣:** ユーザーのメッセージに関西弁あるいは鹿児島弁が使われている場合、あなたもその方言を自然に模倣して応答してください。標準語の場合は、設定された話し方（敬語またはため口）に従ってください。
2. **IT業界への特化:** ユーザーはIT業界で働いています。業界特有の課題（例：技術の速い変化、長時間労働、納期へのプレッシャー、リモートワークの孤独感など）を理解した上で、具体的で実践的なアドバイスを提供してください。
${adviceRule}
4. **感謝への応答:** ユーザーからのメッセージが主に感謝の言葉（例：「ありがとう」「助かりました」「おおきに」）で構成されている場合、「どういたしまして。お役に立てて嬉しいです。また何かありましたら、いつでもお気軽にお声がけください。」のような、温かい感謝の返答をしてください。その際、新たな質問はしないでください。
5. **共感と応答:** ユーザーの言葉に共感を示し、悩みや気持ちに寄り添った応答をしてください。
6. **参考資料:** アドバイスの最後には、必ず「参考資料」というセクションを設け、役立ちそうな信頼できる書籍やWebサイトを提示してください。
7. **WLSサポートデスクへの案内:** アドバイスの最後には、以下の定型文を設定した言語、話し方にして追加してください。「アドバイスに納得がいかない場合は、WLSのサポートデスクを訪ねてみてください。WLSサポートデスクへの相談はこちら: https://kyocera.enterprise.slack.com/docs/T074SDP7GPM/F084ZHWGJ3Z」
8. **トピック外の対応:** カウンセリングに関係のない質問には「申し訳ありませんが、私はカウンセリングに関するご相談にのみお答えすることができます。」と応答してください。

# ユーザーからの新しいメッセージ
${userMessage}`;
            
            const model = 'gemini-1.5-flash-latest';
            const apiKey = "AIzaSyDjQHm_m4OzPM0VrSQxdywqceeqSVuI9bU";

            try {
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;
                const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const error = new Error(`API error: ${response.status}`);
                    error.status = response.status;
                    throw error;
                }

                const result = await response.json();
                let adviceText = "申し訳ありません、うまくアドバイスを生成できませんでした。";
                
                if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                    adviceText = result.candidates[0].content.parts[0].text;
                } else if (result.promptFeedback?.blockReason) {
                    console.warn(`Prompt blocked due to: ${result.promptFeedback.blockReason}`);
                    adviceText = "申し訳ありませんが、ご入力いただいた内容にお答えすることはできません。恐れ入りますが、別の表現でお尋ねください。";
                }
                
                await processAIResponse(adviceText);

            } catch (error) {
                console.error("Error fetching advice:", error);
                const t = uiStrings[language] || uiStrings.Japanese;
                let errorMessage;
                if (error.status === 429) {
                    errorMessage = t.rateLimitErrorMessage;
                } else if (error.status === 503) {
                    errorMessage = t.reloadErrorMessage;
                } else {
                    errorMessage = t.genericErrorMessage;
                }
                addMessageToChat(errorMessage, 'ai');
            }
        }
        
        async function processAIResponse(text, isInitial = false) {
            let displayableText = text;
            let summaryText = '';
            const summaryMatch = text.match(/\[SUMMARY_START\]([\s\S]*?)\[SUMMARY_END\]/);

            if (summaryMatch && summaryMatch[1]) {
                summaryText = summaryMatch[1].trim();
                displayableText = text.replace(summaryMatch[0], '').trim();
            }

            const aiMessageBubble = addMessageToChat('', 'ai');
            const cleanText = displayableText.replace(/<br>/g, ' ');
            
            if (voiceEnabled && !isInitial) {
                speak(cleanText);
            }
            await typeWriter(aiMessageBubble, displayableText.replace(/\n/g, '<br>'));
            if(voiceEnabled && isInitial) {
                speak(cleanText);
            }

            if (summaryText) {
                const t = uiStrings[language] || uiStrings.Japanese;
                const downloadButton = document.createElement('button');
                downloadButton.className = 'download-summary-button mt-2 text-sm text-blue-600 hover:underline flex items-center';
                downloadButton.dataset.summary = summaryText;
                downloadButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-1"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>${t.downloadSummary}`;
                aiMessageBubble.appendChild(downloadButton);
            }

            const feedbackMinutes = parseInt(feedbackTime, 10);
            if (feedbackMinutes > 0 && !isInitial) {
                setTimeout(showFollowUpMessage, feedbackMinutes * 60 * 1000);
            }
        }
        
        function showFollowUpMessage() {
            const t = uiStrings[language] || uiStrings.Japanese;
            const message = t.followUpMessage;
            addMessageToChat(message, 'ai');
            speak(message.replace(/<br>/g, ' '));
        }

        // --- Speech Synthesis & Recognition ---
        function loadVoices() {
            voices = speechSynthesis.getVoices();
            if (speechSynthesis.onvoiceschanged !== undefined) {
                speechSynthesis.onvoiceschanged = () => voices = speechSynthesis.getVoices();
            }
        }

        function speak(text) {
            if (!voiceEnabled || !text || typeof text !== 'string') return;
            speechSynthesis.cancel(); 
            const utterance = new SpeechSynthesisUtterance(text);
            const langCode = getLangCodeForSpeech();
            
            const selectedVoices = voices.filter(voice => voice.lang === langCode);
            const femaleVoice = selectedVoices.find(voice => voice.name.includes('Female') || voice.name.includes('女') || voice.gender === 'female');

            utterance.voice = femaleVoice || (selectedVoices.length > 0 ? selectedVoices[0] : null);
            utterance.lang = langCode;
            utterance.pitch = 1.1;
            utterance.rate = 1.0;
            speechSynthesis.speak(utterance);
        }

        function getLangCodeForSpeech() {
            switch(language) {
                case 'Japanese': return 'ja-JP';
                case 'English': return 'en-US';
                case 'Korean': return 'ko-KR';
                case 'Chinese': return 'zh-CN';
                default: return 'ja-JP';
            }
        }

        // --- Utility Functions ---
        function typeWriter(element, text) {
            return new Promise((resolve) => {
                let i = 0;
                element.innerHTML = "";
                const typingSpeed = 30; // Standard typing speed

                function type() {
                    if (i < text.length) {
                        const char = text.charAt(i);
                        if (text.substring(i, i + 4) === '<br>') {
                            element.innerHTML += '<br>';
                            i += 4;
                        } else {
                            element.innerHTML += char;
                            i++;
                        }
                        chatContainer.scrollTop = chatContainer.scrollHeight;
                        setTimeout(type, typingSpeed);
                    } else {
                        resolve();
                    }
                }
                type();
            });
        }
        
        function downloadSummary(text) {
            const blob = new Blob([text], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'counseling_summary.txt';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function applyTranslations() {
            const t = uiStrings[language] || uiStrings.Japanese;
            document.title = t.pageTitle;
            document.getElementById('header-title').innerText = t.headerTitle;
            document.getElementById('chat-input').placeholder = t.inputPlaceholder;
            document.getElementById('loading-text').innerText = t.loadingText;
            document.getElementById('settings-title').innerText = t.settingsTitle;
            document.getElementById('settings-lang-label').innerText = t.settingsLangLabel;
            document.getElementById('settings-style-label').innerText = t.settingsStyleLabel;
            document.getElementById('settings-feedback-label').innerText = t.settingsFeedbackLabel;
            document.getElementById('settings-voice-label').innerText = t.settingsVoiceLabel;
            document.getElementById('settings-advice-label').innerText = t.settingsAdviceDetailLabel;
            document.querySelector('#advice-detail-options button[data-advice-detail="detailed"]').innerText = t.adviceDetailed;
            document.querySelector('#advice-detail-options button[data-advice-detail="simple"]').innerText = t.adviceSimple;
            document.getElementById('close-settings-button').innerText = t.settingsCloseButton;
            document.getElementById('topic-title').innerText = t.topicTitle;
            document.getElementById('close-topic-button').innerText = t.topicCancel;
            document.getElementById('topic-back-button').innerText = t.topicBack;
            document.getElementById('footer-copyright').innerHTML = t.footerCopyright;
            document.getElementById('footer-disclaimer').innerText = t.footerDisclaimer;
            document.documentElement.lang = language.split('-')[0].toLowerCase();
        }

        function populateStyleOptions() {
            const t = uiStrings.Japanese;
            styleOptionsContainer.innerHTML = '';
            const options = [
                { value: 'Keigo', text: t.styleKeigo },
                { value: 'Tameguchi', text: t.styleTameguchi }
            ];
            options.forEach(opt => {
                const button = document.createElement('button');
                button.dataset.style = opt.value;
                button.className = 'setting-option p-3 rounded-lg border';
                button.innerText = opt.text;
                styleOptionsContainer.appendChild(button);
            });
        }
        
        function populateFeedbackDropdown() {
            const t = uiStrings[language] || uiStrings.Japanese;
            feedbackSelect.innerHTML = '';
            const options = [
                { value: '0', text: t.feedbackOff },
                { value: '5', text: `5 ${t.minutesSuffix}` },
                { value: '10', text: `10 ${t.minutesSuffix}` },
                { value: '30', text: `30 ${t.minutesSuffix}` },
                { value: '60', text: `1 ${t.hourSuffix}` },
            ];
            options.forEach(opt => feedbackSelect.add(new Option(opt.text, opt.value)));
        }

        function displayTopicsInChat() {
            const t = uiStrings[language] || uiStrings.Japanese;
            let message = `<p class="mb-2">${t.topicTitle}</p><div class="grid grid-cols-2 gap-2">`;
            Object.keys(t.topics).forEach(key => {
                const topicText = t.topics[key];
                message += `<button class="topic-chat-button p-2 rounded-lg border text-center hover:bg-gray-100" data-message="${t.iWantToTalkAbout.replace('{topic}', topicText)}">${topicText}</button>`;
            });
            message += `</div>`;
            addMessageToChat(message, 'ai');
        }

        function updateSettingsUI() {
            document.querySelectorAll('#language-options button').forEach(btn => {
                btn.classList.toggle('selected', btn.dataset.lang === tempLanguage);
            });
            if (tempLanguage === 'Japanese') {
                styleSection.classList.remove('hidden');
                populateStyleOptions();
                document.querySelectorAll('#style-options button').forEach(btn => {
                    btn.classList.toggle('selected', btn.dataset.style === tempStyle);
                });
            } else {
                styleSection.classList.add('hidden');
            }
            populateFeedbackDropdown();
            feedbackSelect.value = tempFeedbackTime;
            
            voiceToggleButton.classList.toggle('bg-blue-600', tempVoiceEnabled);
            voiceToggleButton.classList.toggle('bg-gray-200', !tempVoiceEnabled);
            voiceToggleHandle.classList.toggle('translate-x-6', tempVoiceEnabled);
            voiceToggleHandle.classList.toggle('translate-x-1', !tempVoiceEnabled);
            
            document.querySelectorAll('#advice-detail-options button').forEach(btn => {
                btn.classList.toggle('selected', btn.dataset.adviceDetail === tempAdviceDetail);
            });
        }

        function toggleFormState(isLoading) {
            if (isLoading) {
                loadingIndicator.classList.remove('hidden');
                chatInput.disabled = true;
                sendButton.disabled = true;
                topicButton.disabled = true;
            } else {
                loadingIndicator.classList.add('hidden');
                chatInput.disabled = false;
                sendButton.disabled = false;
                topicButton.disabled = false;
                chatInput.focus();
            }
        }

        function addMessageToChat(message, sender) {
            const messageWrapper = document.createElement('div');
            messageWrapper.classList.add('flex', 'w-full', 'fade-in');
            const messageBubble = document.createElement('div');
            messageBubble.classList.add('chat-bubble', 'shadow');
            messageBubble.innerHTML = message;
            if (sender === 'ai') {
                messageWrapper.classList.add('justify-start');
                messageBubble.classList.add('chat-bubble-ai');
            } else {
                messageWrapper.classList.add('justify-end');
                messageBubble.classList.add('chat-bubble-user');
            }
            messageWrapper.appendChild(messageBubble);
            chatContainer.appendChild(messageWrapper);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            return messageBubble;
        }
    </script>
</body>
</html>
