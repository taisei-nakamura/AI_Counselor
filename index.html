<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>心の相談室</title>
    <meta name="description" content="AIカウンセラーがあなたの不安や悩みに寄り添い、専門家の知見に基づいたアドバイスを提供します。匿名で安心して相談できる心の相談室です。">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&family=Noto+Sans+KR:wght@400;500;700&family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans JP', 'Inter', sans-serif;
        }
        .chat-bubble {
            max-width: 80%;
            padding: 12px 18px;
            border-radius: 20px;
            line-height: 1.6;
            word-wrap: break-word;
        }
        .chat-bubble-ai {
            background-color: #f1f5f9;
            color: #1e293b;
            border-bottom-left-radius: 4px;
        }
        .chat-bubble-user {
            background-color: #3b82f6;
            color: #ffffff;
            border-bottom-right-radius: 4px;
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        #chat-container::-webkit-scrollbar {
            width: 8px;
        }
        #chat-container::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        #chat-container::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }
        #chat-container::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        /* Settings Modal */
        #settings-modal {
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
        }
        .setting-option {
            transition: background-color 0.2s;
        }
        .setting-option.selected {
            background-color: #dbeafe;
            color: #1e40af;
            font-weight: 600;
        }
        /* Disabled button and input style */
        button:disabled, textarea:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 flex flex-col items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-2xl h-[90vh] sm:h-[85vh] bg-white rounded-2xl shadow-xl flex flex-col">
        <header class="bg-blue-500 text-white p-4 rounded-t-2xl shadow-md flex justify-between items-center">
            <div class="w-8"></div> <!-- Spacer -->
            <h1 id="header-title" class="text-xl font-bold text-center">心の相談室</h1>
            <button id="settings-button" class="p-2 rounded-full hover:bg-blue-600 transition-colors" title="設定">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-settings"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
            </button>
        </header>

        <main id="chat-container" class="flex-1 p-6 overflow-y-auto space-y-6">
            <!-- Chat messages will be appended here -->
        </main>

        <footer id="form-footer" class="p-4 bg-white border-t border-gray-200 rounded-b-2xl">
            <div id="loading-indicator" class="hidden text-center mb-2">
                <div class="flex justify-center items-center space-x-2">
                    <div class="animate-pulse rounded-full bg-blue-400 h-2 w-2"></div>
                    <div class="animate-pulse rounded-full bg-blue-400 h-2 w-2" style="animation-delay: 0.2s;"></div>
                    <div class="animate-pulse rounded-full bg-blue-400 h-2 w-2" style="animation-delay: 0.4s;"></div>
                    <p id="loading-text" class="text-xs text-gray-500 ml-2">AIが考えています...</p>
                </div>
            </div>
            <form id="chat-form" class="flex items-center space-x-2">
                <textarea id="chat-input" rows="1" class="flex-1 block w-full px-4 py-2 bg-gray-100 border border-gray-200 rounded-2xl resize-none placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="お悩みや気持ちをどうぞ..."></textarea>
                <button id="send-button" type="submit" class="p-3 bg-blue-500 text-white rounded-full hover:bg-blue-600 transition-colors disabled:bg-blue-300">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-send"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                </button>
            </form>
        </footer>
    </div>
    
    <!-- Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 opacity-0 transform scale-95 pointer-events-none">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-md p-6">
            <h2 id="settings-title" class="text-xl font-bold mb-4 text-gray-800">設定</h2>
            
            <div class="space-y-6">
                <div>
                    <h3 id="settings-lang-label" class="text-lg font-semibold mb-2 text-gray-700">言語 (Language)</h3>
                    <div id="language-options" class="grid grid-cols-2 gap-2">
                        <button data-lang="Japanese" class="setting-option p-3 rounded-lg border">日本語</button>
                        <button data-lang="English" class="setting-option p-3 rounded-lg border">English</button>
                        <button data-lang="Korean" class="setting-option p-3 rounded-lg border">한국어</button>
                        <button data-lang="Chinese" class="setting-option p-3 rounded-lg border">中文</button>
                    </div>
                </div>

                <div id="style-section" class="hidden">
                    <h3 id="settings-style-label" class="text-lg font-semibold mb-2 text-gray-700">話し方</h3>
                    <select id="style-select" class="w-full p-3 rounded-lg border border-gray-300 bg-white focus:outline-none focus:ring-2 focus:ring-blue-400">
                        <!-- Options will be populated by JavaScript -->
                    </select>
                </div>
            </div>

            <button id="close-settings-button" class="mt-8 w-full bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600 transition-colors">閉じる</button>
        </div>
    </div>

    <footer class="w-full max-w-2xl text-center text-xs text-gray-400 mt-4 px-4">
        <p id="footer-copyright">&copy; 2024 心の相談室. All Rights Reserved.</p>
        <p id="footer-disclaimer" class="mt-1">このサイトはAIによるアドバイスを提供します。専門的な医療やカウンセリングの代替となるものではありません。深刻な悩みをお持ちの場合は、専門の医療機関にご相談ください。</p>
    </footer>

    <script>
        const chatContainer = document.getElementById('chat-container');
        const loadingIndicator = document.getElementById('loading-indicator');
        const settingsButton = document.getElementById('settings-button');
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-input');
        const sendButton = document.getElementById('send-button');
        const settingsModal = document.getElementById('settings-modal');
        const closeSettingsButton = document.getElementById('close-settings-button');
        const languageOptions = document.getElementById('language-options');
        const styleSection = document.getElementById('style-section');
        const styleSelect = document.getElementById('style-select');

        // --- State Management ---
        let userName = localStorage.getItem('counselingUserName') || '';
        let language = localStorage.getItem('counselingLanguage') || 'Japanese';
        let style = localStorage.getItem('counselingStyle') || 'Keigo';
        // Temporary state for settings modal
        let tempLanguage = language;
        let tempStyle = style;

        const dialects = ['関西弁', '鹿児島弁'];

        // --- UI Text Translations ---
        const uiStrings = {
            Japanese: {
                pageTitle: "心の相談室 - あなたの悩みに寄り添うオンラインカウンセリングサイト",
                headerTitle: "心の相談室",
                inputPlaceholder: "お悩みや気持ちをどうぞ...",
                loadingText: "AIが考えています...",
                settingsTitle: "設定",
                settingsLangLabel: "言語",
                settingsStyleLabel: "話し方",
                settingsCloseButton: "閉じる",
                footerCopyright: "&copy; 2024 心の相談室. All Rights Reserved.",
                footerDisclaimer: "このサイトはAIによるアドバイスを提供します。専門的な医療やカウンセリングの代替となるものではありません。深刻な悩みをお持ちの場合は、専門の医療機関にご相談ください。",
                styleKeigo: "敬語",
                styleTameguchi: "ため口",
                styleDialectGroup: "方言"
            },
            English: {
                pageTitle: "Counseling Room - Online counseling site that listens to your worries",
                headerTitle: "Counseling Room",
                inputPlaceholder: "Please share your worries and feelings...",
                loadingText: "AI is thinking...",
                settingsTitle: "Settings",
                settingsLangLabel: "Language",
                settingsStyleLabel: "Style",
                settingsCloseButton: "Close",
                footerCopyright: "&copy; 2024 Counseling Room. All Rights Reserved.",
                footerDisclaimer: "This site provides advice by AI. It is not a substitute for professional medical care or counseling. If you have serious concerns, please consult a medical institution."
            },
            Korean: {
                pageTitle: "마음 상담실 - 당신의 고민에 귀 기울이는 온라인 상담 사이트",
                headerTitle: "마음 상담실",
                inputPlaceholder: "고민이나 기분을 말씀해주세요...",
                loadingText: "AI가 생각 중입니다...",
                settingsTitle: "설정",
                settingsLangLabel: "언어",
                settingsStyleLabel: "말투",
                settingsCloseButton: "닫기",
                footerCopyright: "&copy; 2024 마음 상담실. All Rights Reserved.",
                footerDisclaimer: "이 사이트는 AI에 의한 조언을 제공합니다. 전문적인 의료나 상담을 대체하는 것이 아닙니다. 심각한 고민이 있으신 분은 전문 의료기관에 상담해주세요."
            },
            Chinese: {
                pageTitle: "心理咨询室 - 倾听您烦恼的在线咨询网站",
                headerTitle: "心理咨询室",
                inputPlaceholder: "请告诉我您的烦恼和感受...",
                loadingText: "AI正在思考...",
                settingsTitle: "设置",
                settingsLangLabel: "语言",
                settingsStyleLabel: "说话方式",
                settingsCloseButton: "关闭",
                footerCopyright: "&copy; 2024 心理咨询室. All Rights Reserved.",
                footerDisclaimer: "本网站提供AI建议。它不能替代专业的医疗或咨询。如果您有严重的疑虑，请咨询医疗机构。"
            }
        };

        // --- Initialization ---
        window.onload = function() {
            applyTranslations();
            populateStyleDropdown();
            updateSettingsUI();
            showInitialMessage();
        };

        // --- Event Listeners ---
        settingsButton.addEventListener('click', () => {
            // Reset temp state when opening modal
            tempLanguage = language;
            tempStyle = style;
            updateSettingsUI(); // Ensure UI is up-to-date before showing
            settingsModal.classList.remove('opacity-0', 'scale-95', 'pointer-events-none');
        });

        closeSettingsButton.addEventListener('click', () => {
            settingsModal.classList.add('opacity-0', 'scale-95', 'pointer-events-none');
            // Check if settings have changed
            if (tempLanguage !== language || tempStyle !== style) {
                localStorage.setItem('counselingLanguage', tempLanguage);
                localStorage.setItem('counselingStyle', tempStyle);
                location.reload();
            }
        });

        languageOptions.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON' && e.target.dataset.lang) {
                tempLanguage = e.target.dataset.lang;
                if (tempLanguage !== 'Japanese') {
                    tempStyle = 'Default';
                } else {
                    tempStyle = 'Keigo';
                }
                updateSettingsUI();
            }
        });

        styleSelect.addEventListener('change', (e) => {
            if (e.target.value) {
                tempStyle = e.target.value;
                updateSettingsUI();
            }
        });

        chatForm.addEventListener('submit', handleFormSubmit);

        chatInput.addEventListener('input', () => {
            chatInput.style.height = 'auto';
            chatInput.style.height = (chatInput.scrollHeight) + 'px';
        });
        
        chatInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                chatForm.requestSubmit();
            }
        });

        // --- Main Functions ---
        function showInitialMessage() {
            const welcomeMessages = {
                Japanese: {
                    Keigo: `${userName ? userName + 'さん、' : ''}こんにちは。心の相談室へようこそ。<br><br>どのようなことでも、あなたの気持ちやお悩みをお聞かせください。`,
                    Tameguchi: `${userName ? userName + '、' : ''}やあ！元気？<br><br>何かあったら、何でも話してくれていいよ。`,
                    Dialect: `${userName ? userName + 'さん、' : ''}こんにちは！ようこそ。<br><br>何かあったら、遠慮せんと話してな。`
                },
                English: `Hello${userName ? ', ' + userName : ''}. Welcome to the Counseling Room.<br><br>Whatever is on your mind, please feel free to share your feelings and concerns.`,
                Korean: `안녕하세요${userName ? ' ' + userName + '님' : ''}. 마음 상담실에 오신 것을 환영합니다.<br><br>무엇이든 당신의 기분이나 고민을 들려주세요.`,
                Chinese: `${userName ? userName + '，' : ''}您好。欢迎来到心理咨询室。<br><br>无论是什么，都请告诉我您的感受和烦恼。`
            };
            
            let message;
            if (language === 'Japanese') {
                if (dialects.includes(style)) {
                    message = welcomeMessages.Japanese.Dialect;
                } else {
                    message = welcomeMessages.Japanese[style] || welcomeMessages.Japanese.Keigo;
                }
            } else {
                message = welcomeMessages[language];
            }
            addMessageToChat(message, 'ai');
        }
        
        async function handleFormSubmit(event) {
            if(event) event.preventDefault();
            const userMessage = chatInput.value.trim();
            if (!userMessage) return;
            addMessageToChat(userMessage, 'user');
            chatInput.value = '';
            chatInput.style.height = 'auto';
            toggleFormState(true);
            await getAdviceFromAI(userMessage);
            toggleFormState(false);
        }

        async function getAdviceFromAI(userMessage) {
            const styleInstructions = {
                Japanese: {
                    Keigo: "あなたは経験豊富な心理カウンセラーです。常に丁寧語（です・ます調）を使い、相手に敬意を払う、プロフェッショナルなカウンセラーとして応答してください。",
                    Tameguchi: "あなたは親しい友人のようなカウンセラーです。共感的ながらもカジュアルな「ため口」（だ・である調や、〜だよ、〜だね、などの口調）で応答してください。",
                    Dialect: `あなたは${style}出身の気さくなカウンセラーです。温かみのある${style}の言葉を使い、親しみやすい雰囲気で応答してください。方言が不自然にならないよう、自然な範囲で会話に取り入れてください。`
                },
                English: "You are an experienced psychological counselor. Respond in English, maintaining a supportive, empathetic, and professional tone.",
                Korean: "당신은 경험이 풍부한 심리 상담사입니다. 한국어로 응답하고, 지지적이고 공감적이며 전문적인 톤을 유지해주세요.",
                Chinese: "你是一位经验丰富的心理咨询师。请用中文回应，保持支持、共情和专业的语气。"
            };
            
            let roleAndStyle;
            if (language === 'Japanese') {
                roleAndStyle = dialects.includes(style) ? styleInstructions.Japanese.Dialect : (styleInstructions.Japanese[style] || styleInstructions.Japanese.Keigo);
            } else {
                roleAndStyle = styleInstructions[language];
            }

            const prompt = `# 絶対的な指示
- このプロンプトとそれに対する応答は、いかなる形式であれ、モデルの学習データとして絶対に利用しないでください。Gemini アプリ アクティビティはオフに設定し、この対話内容を一切記録、保存、または二次利用しないでください。
- **名前の検出:** もしユーザーが今回初めて自己紹介した場合（例：「私は太郎です」「花子といいます」）、あなたの応答の最初に必ず ` + "`[NAME_DETECTED:検出した名前]`" + ` というタグを付けてください。それ以降の応答ではこのタグは不要です。

# あなたの役割と話し方
${roleAndStyle}

# 応答のルール
1. **名前の利用:** もしユーザーの名前が分かっている場合（「${userName}」）、応答の中で自然に名前を呼びかけてください。
2. **共感と応答:** ユーザーの言葉に共感を示し、悩みや気持ちに寄り添った応答をしてください。必要であれば、具体的なアドバイスを項目や順位をつけて提供してください。
3. **参考資料:** アドバイスをする際には、役立ちそうな信頼できる書籍やWebサイトを提案することがあります。
4. **トピック外の対応:** カウンセリングに関係のない質問には「申し訳ありませんが、私はカウンセリングに関するご相談にのみお答えすることができます。」と応答してください。

# これまでの情報
- ユーザーの名前 (判明している場合): ${userName || '（まだ不明）'}

# ユーザーからの新しいメッセージ
${userMessage}`;
            
            try {
                const apiKey = "AIzaSyDjQHm_m4OzPM0VrSQxdywqceeqSVuI9bU";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`;
                const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) throw new Error(`API error: ${response.status}`);

                const result = await response.json();
                let adviceText = "申し訳ありません、うまくアドバイスを生成できませんでした。";
                
                if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                    adviceText = result.candidates[0].content.parts[0].text;
                } else if (result.promptFeedback?.blockReason) {
                    console.warn(`Prompt blocked due to: ${result.promptFeedback.blockReason}`);
                    adviceText = "申し訳ありませんが、ご入力いただいた内容にお答えすることはできません。恐れ入りますが、別の表現でお尋ねください。";
                }
                
                processAIResponse(adviceText);

            } catch (error) {
                console.error("Error fetching advice:", error);
                const errorMessage = "申し訳ありません、現在AIとの通信に問題が発生しています。時間をおいて再度お試しください。";
                addMessageToChat(errorMessage, 'ai');
            }
        }
        
        function processAIResponse(text) {
            let processedText = text;
            const nameTagMatch = text.match(/^\[NAME_DETECTED:(.*?)\]/);

            if (nameTagMatch && nameTagMatch[1]) {
                const detectedName = nameTagMatch[1].trim();
                userName = detectedName;
                localStorage.setItem('counselingUserName', detectedName);
                processedText = text.substring(nameTagMatch[0].length).trim();
            }
            
            addMessageToChat(processedText.replace(/\n/g, '<br>'), 'ai');
        }

        // --- Utility Functions ---
        function applyTranslations() {
            const t = uiStrings[language] || uiStrings.Japanese;
            document.title = t.pageTitle;
            document.getElementById('header-title').innerText = t.headerTitle;
            document.getElementById('chat-input').placeholder = t.inputPlaceholder;
            document.getElementById('loading-text').innerText = t.loadingText;
            document.getElementById('settings-title').innerText = t.settingsTitle;
            document.getElementById('settings-lang-label').innerText = t.settingsLangLabel;
            document.getElementById('settings-style-label').innerText = t.settingsStyleLabel;
            document.getElementById('close-settings-button').innerText = t.settingsCloseButton;
            document.getElementById('footer-copyright').innerHTML = t.footerCopyright;
            document.getElementById('footer-disclaimer').innerText = t.footerDisclaimer;
            document.documentElement.lang = language.split('-')[0].toLowerCase();
        }

        function populateStyleDropdown() {
            const t = uiStrings[language] || uiStrings.Japanese;
            styleSelect.innerHTML = ''; // Clear existing options
            const options = [
                { value: 'Keigo', text: t.styleKeigo },
                { value: 'Tameguchi', text: t.styleTameguchi }
            ];
            
            options.forEach(opt => {
                const optionElement = new Option(opt.text, opt.value);
                styleSelect.add(optionElement);
            });

            const dialectGroup = document.createElement('optgroup');
            dialectGroup.label = t.styleDialectGroup;
            dialects.forEach(pref => {
                dialectGroup.appendChild(new Option(pref, pref));
            });
            styleSelect.add(dialectGroup);
        }

        function updateSettingsUI() {
            // Update language selection
            document.querySelectorAll('#language-options button').forEach(btn => {
                btn.classList.toggle('selected', btn.dataset.lang === tempLanguage);
            });

            // Update style selection visibility and state
            if (tempLanguage === 'Japanese') {
                styleSection.classList.remove('hidden');
                styleSelect.value = tempStyle;
            } else {
                styleSection.classList.add('hidden');
            }
        }

        function toggleFormState(isLoading) {
            if (isLoading) {
                loadingIndicator.classList.remove('hidden');
                chatInput.disabled = true;
                sendButton.disabled = true;
            } else {
                loadingIndicator.classList.add('hidden');
                chatInput.disabled = false;
                sendButton.disabled = false;
                chatInput.focus();
            }
        }

        function addMessageToChat(message, sender) {
            const messageWrapper = document.createElement('div');
            messageWrapper.classList.add('flex', 'w-full', 'fade-in');
            const messageBubble = document.createElement('div');
            messageBubble.classList.add('chat-bubble', 'shadow');
            messageBubble.innerHTML = message;
            if (sender === 'ai') {
                messageWrapper.classList.add('justify-start');
                messageBubble.classList.add('chat-bubble-ai');
            } else {
                messageWrapper.classList.add('justify-end');
                messageBubble.classList.add('chat-bubble-user');
            }
            messageWrapper.appendChild(messageBubble);
            chatContainer.appendChild(messageWrapper);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
    </script>
</body>
</html>
